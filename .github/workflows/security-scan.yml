name: ðŸ”’ Security Scan 2025

on:
  pull_request:
    branches: [main, develop, master]
  push:
    branches: [main, develop, master]
  schedule:
    # Run every Monday at 2 AM
    - cron: '0 2 * * 1'
  workflow_dispatch: # Allow manual trigger

concurrency:
  group: security-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Temporarily disabled - Swarm agent has crypto compatibility issues with Node 18+
  # Re-enable after fixing crypto imports in agents/swarm/
  # security-agent-scan:
  #   name: Security Agent 2025 SAST/DAST
  #   runs-on: ubuntu-latest
  #   timeout-minutes: 30
  #   steps:
  #     - name: ðŸ“¥ Checkout code
  #       uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0
  #     - name: ðŸ”§ Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '18'
  #         cache: 'npm'
  #     - name: ðŸ“¦ Install dependencies
  #       run: npm ci
  #     - name: ðŸ” Run Security Agent 2025
  #       run: npm run swarm:start "automated security scan" || true

  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ” npm audit
        run: npm audit --audit-level=high --production
        continue-on-error: true

      - name: ðŸ“Š Generate audit report
        run: |
          npm audit --json > npm-audit.json || true
          npm audit --production > npm-audit.txt || true

      - name: ðŸ“¤ Upload audit results
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-report
          path: |
            npm-audit.json
            npm-audit.txt

  secret-scan:
    name: Secret Detection
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Scan for secrets
        run: |
          echo "Scanning for hardcoded secrets..."

          # Check for common secret patterns (excluding .env.example files)
          if git diff-tree --no-commit-id --name-only -r ${{ github.sha }} | grep -v "\.env\.example$" | xargs grep -iE "(password|secret|api[_-]?key)\s*[:=]\s*['\"][^'\"]{8,}" 2>/dev/null; then
            echo "::error::Potential hardcoded secrets detected!"
            exit 1
          fi

          # Check for NEXT_PUBLIC_ secrets (excluding PUBLISHABLE_KEY which is safe by design)
          if git diff-tree --no-commit-id --name-only -r ${{ github.sha }} | xargs grep -E "NEXT_PUBLIC_.*(SECRET|PRIVATE|TOKEN|PASSWORD)" 2>/dev/null; then
            echo "::error::Secret exposed via NEXT_PUBLIC_ prefix!"
            exit 1
          fi

          # Check specifically for API keys (but allow in documentation/templates)
          if git diff-tree --no-commit-id --name-only -r ${{ github.sha }} | grep -v -E "\.(md|example|template)$" | xargs grep -E "NEXT_PUBLIC_.*API.*KEY" 2>/dev/null; then
            echo "::warning::API key found with NEXT_PUBLIC prefix - verify this is intentional"
            echo "Files with NEXT_PUBLIC_API_KEY detected. Please review:"
            git diff-tree --no-commit-id --name-only -r ${{ github.sha }} | grep -v -E "\.(md|example|template)$" | xargs grep -l "NEXT_PUBLIC_.*API.*KEY" 2>/dev/null || true
            exit 1
          fi

          echo "âœ… No hardcoded secrets detected"

  sast-analysis:
    name: Static Code Analysis (CodeQL)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”§ Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript,typescript
          queries: security-and-quality

      - name: ðŸ—ï¸ Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: ðŸ” Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  summary:
    name: ðŸ“Š Security Summary
    runs-on: ubuntu-latest
    needs: [dependency-scan, secret-scan]
    if: always()

    steps:
      - name: ðŸ“‹ Generate Summary
        run: |
          echo "# ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Scan | ${{ needs.dependency-scan.result == 'success' && 'âœ… Passed' || 'âš ï¸ Review' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Detection | ${{ needs.secret-scan.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â„¹ï¸ Security Agent 2025 temporarily disabled - see workflow for details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.dependency-scan.result }}" == "success" ] && [ "${{ needs.secret-scan.result }}" == "success" ]; then
            echo "âœ… All active security checks passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Some security checks need attention. Review the results above." >> $GITHUB_STEP_SUMMARY
          fi
