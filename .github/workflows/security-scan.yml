name: ðŸ”’ Security Scan 2025

on:
  pull_request:
    branches: [main, develop, master]
  push:
    branches: [main, develop, master]
  schedule:
    # Run every Monday at 2 AM
    - cron: '0 2 * * 1'
  workflow_dispatch: # Allow manual trigger

concurrency:
  group: security-${{ github.ref }}
  cancel-in-progress: true

jobs:
  security-agent-scan:
    name: Security Agent 2025 SAST/DAST
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for better analysis

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ” Run Security Agent 2025
        id: security_scan
        run: |
          npm run swarm:start "automated security scan" || true
          echo "scan_completed=true" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: ðŸ“Š Parse Security Results
        id: parse_results
        run: |
          # Find latest session file
          SESSION_FILE=$(ls -t agents/swarm/sessions/*.json 2>/dev/null | head -1)

          if [ -f "$SESSION_FILE" ]; then
            CRITICAL=$(jq '.tasks[] | select(.agent == "SECURITY") | .output.critical // 0' "$SESSION_FILE")
            HIGH=$(jq '.tasks[] | select(.agent == "SECURITY") | .output.high // 0' "$SESSION_FILE")
            MEDIUM=$(jq '.tasks[] | select(.agent == "SECURITY") | .output.medium // 0' "$SESSION_FILE")
            PASSED=$(jq '.tasks[] | select(.agent == "SECURITY") | .output.passed // false' "$SESSION_FILE")

            echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
            echo "high=$HIGH" >> $GITHUB_OUTPUT
            echo "medium=$MEDIUM" >> $GITHUB_OUTPUT
            echo "passed=$PASSED" >> $GITHUB_OUTPUT

            # Extract report
            jq -r '.tasks[] | select(.agent == "SECURITY") | .output.report // ""' "$SESSION_FILE" > security-report.md
          else
            echo "critical=0" >> $GITHUB_OUTPUT
            echo "high=0" >> $GITHUB_OUTPUT
            echo "medium=0" >> $GITHUB_OUTPUT
            echo "passed=true" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ“¤ Upload Security Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-scan-report
          path: |
            agents/swarm/sessions/
            security-report.md
          retention-days: 30

      - name: ðŸ’¬ Comment on PR
        if: github.event_name == 'pull_request' && steps.parse_results.outputs.passed == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let report = '## ðŸ”’ Security Scan Results\n\n';

            if (fs.existsSync('security-report.md')) {
              report += fs.readFileSync('security-report.md', 'utf8');
            } else {
              report += 'âš ï¸ Security scan completed with issues. Check artifacts for details.';
            }

            report += `\n\n---\n`;
            report += `ðŸ”´ Critical: ${{ steps.parse_results.outputs.critical }}\n`;
            report += `ðŸŸ  High: ${{ steps.parse_results.outputs.high }}\n`;
            report += `ðŸŸ¡ Medium: ${{ steps.parse_results.outputs.medium }}\n`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

      - name: âŒ Fail if Critical Issues
        if: steps.parse_results.outputs.critical > 0
        run: |
          echo "::error::Security scan failed with ${{ steps.parse_results.outputs.critical }} critical issue(s)"
          exit 1

  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ” npm audit
        run: npm audit --audit-level=high --production
        continue-on-error: true

      - name: ðŸ“Š Generate audit report
        run: |
          npm audit --json > npm-audit.json || true
          npm audit --production > npm-audit.txt || true

      - name: ðŸ“¤ Upload audit results
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-report
          path: |
            npm-audit.json
            npm-audit.txt

  secret-scan:
    name: Secret Detection
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Scan for secrets
        run: |
          echo "Scanning for hardcoded secrets..."

          # Check for common secret patterns
          if git diff-tree --no-commit-id --name-only -r ${{ github.sha }} | xargs grep -iE "(password|secret|api[_-]?key)\s*[:=]\s*['\"][^'\"]{8,}" 2>/dev/null; then
            echo "::error::Potential hardcoded secrets detected!"
            exit 1
          fi

          # Check for NEXT_PUBLIC_ secrets
          if git diff-tree --no-commit-id --name-only -r ${{ github.sha }} | xargs grep -E "NEXT_PUBLIC_.*(SECRET|PRIVATE|KEY|TOKEN|PASSWORD)" 2>/dev/null; then
            echo "::error::Secret exposed via NEXT_PUBLIC_ prefix!"
            exit 1
          fi

          echo "âœ… No hardcoded secrets detected"

  sast-analysis:
    name: Static Code Analysis (CodeQL)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”§ Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript,typescript
          queries: security-and-quality

      - name: ðŸ—ï¸ Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: ðŸ” Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  summary:
    name: ðŸ“Š Security Summary
    runs-on: ubuntu-latest
    needs: [security-agent-scan, dependency-scan, secret-scan]
    if: always()

    steps:
      - name: ðŸ“‹ Generate Summary
        run: |
          echo "# ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Security Agent 2025 | ${{ needs.security-agent-scan.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Scan | ${{ needs.dependency-scan.result == 'success' && 'âœ… Passed' || 'âš ï¸ Review' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Detection | ${{ needs.secret-scan.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.security-agent-scan.result }}" != "success" ]; then
            echo "âš ï¸ Security scan found critical issues. Review the artifacts for details." >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… All security checks passed!" >> $GITHUB_STEP_SUMMARY
          fi
